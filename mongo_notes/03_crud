----------------------------------------------------
CHAPTER 3 - CRUD
----------------------------------------------------

- Inserting Documents

    - To insert a single document, the 'insertOne' method is used.

        > db.movies.insertOne({'title': 'Stand By Me'})


    - To insert multiple documents, the 'insertMany' method is used.  Instead of making a round trip to
        the database for each insert, they will be inserted in bulk.

        > db.movies.insertMany([{'title': 'Ghostbusters'},
                                {'title': 'E.T.'},
                                {'title': 'Blade Runner'}]);


    - Current versions of Mongo don't support messages longer than 48 MB, so there is a hard limit to how
        many inserts can be done at one time.  If you try to insert more than 48MB, many drivers will split
        your insert into multiple 48MB operations.


    - There are 2 options for dealing with errors that occur during 'insertMany' operations.

        1. If we specify 'true' for the 'ordered' key, the insert will ensure that the documents are
             inserted in the order they are provided.  If a document produces an error during the insert,
             no documents beyond that point in the array will be inserted.  This is the default option
             for 'insertMany'.

        2. If we specfiy 'false' for the 'ordered' key, Mongo may reorder the inserts to improve
             performance.  If an error occurs, the insert operation will keep trying to insert as many
             documents as possible.


        // Unordered insertMany, fails since the ids are duplicated
        > db.movies.insertMany([
            {'_id' : 3, 'title' : 'Sixteen Candles'},
            {'_id' : 4, 'title' : 'The Terminator'},
            {'_id' : 4, 'title' : 'The Princess Bride'},
            {'_id' : 5, 'title' : 'Scarface'}],
          {'ordered': false})


    - The validation done on insert operations is minimal.  It checks the document's basic structure, adds
        an '_id' field if one does not exist, and makes sure all documents are less than 16 MB.


    - In Mongo versions <3.0, the 'insert' operation was the primary method for inserting documents.  As
        of Mongo 3.2, this is still suppored for backwards compatibility.



- Removing Documents

    - The 'deleteOne' method is used to delete a document.  It will delete the first document that matches
        the filter.

        > db.movies.deleteOne({'_id' : 4})


    - The 'deleteMany' method will delete all documents that match the filter.

        > db.movies.deleteMany({'year' : 1984})


    - In Mongo versions <3.0, the 'remove' operations was the primary method for deleting documents.


    - If you want to clear an entire collection, it is faster to use the 'drop' method.

        > db.movies.drop()



- Updating Documents

    - The 'updateOne' and 'updateMany' operations each take a filter document as their first parameter
        and the changes to make as the second parameter.  


    - The 'replaceOne' method takes a filter as its first parameter, then the document that will replace it
        as the second parameter.



- Document Replacement

    - The 'replaceOne' operation can be useful when making major schema changes.  For instance, suppose
        we have a document like this:

        {
          '_id' : ObjectId('4b2b9f67a1f631733d917a7a'),
          'name' : 'joe',
          'friends' : 32,
          'enemies' : 2
        }


    - Now, let's say we want to move the 'friends' and 'enemies' fields into a 'relationships' subdocument.
        We can change the structure of the document in the shell, then replace the database's version
        of the document with 'replaceOne'.

        > var joe = db.users.findOne({'name' : 'joe'});
        > joe.relationships = {'friends' : joe.friends, 'enemies' : joe.enemies};
        > joe.username = joe.name;

        > delete joe.friends;
        > delete joe.enemies;
        > delete joe.name;

        > db.users.replaceOne({'name' : 'joe'}, joe);


    - Note that this will cause an error, since there are multiple documents that match the condition
        to the 'replaceOne', and the insert will cause a duplicate key error.  This is a very common 
        error!

        // There are 3 people with name 'joe'
        > db.people.find()
        {"_id" : ObjectId("4b2b9f67a1f631733d917a7b"), "name" : "joe", "age" : 65},
        {"_id" : ObjectId("4b2b9f67a1f631733d917a7c"), "name" : "joe", "age" : 20},
        {"_id" : ObjectId("4b2b9f67a1f631733d917a7d"), "name" : "joe", "age" : 49},

        > joe = db.people.findOne({"name" : "joe", "age" : 20});
        {
          "_id" : ObjectId("4b2b9f67a1f631733d917a7c"),
          "name" : "joe",
          "age" : 20
        }

        > joe.age++;
        > db.people.replaceOne({"name" : "joe"}, joe);
        E11001 duplicate key on update


        // Using the _id for the filter will guarantee you won't have a duplicate key problem
        > db.people.replaceOne({'_id' : ObjectId("4b2b9f67a1f631733d917a7c")})



- Using Update Operators

    - Usually, only certain portions of a document need to be updated.  You can update specific fields in
        a document using atomic 'update operators'.  Update operators are special keys that can be used
        to specify complex update operations.


    - For instance, if we have the following document:

        {
          '_id' : ObjectId('4b253b067525f35f94b60a31'),
          'url' : 'www.example.com',
          'pageviews' : 52
        }

      To increment the page views, we use the '$inc' modifier:

        > db.analytics.updateOne({'url' : 'www.example.com'}, 
                                 {'$inc' : {'pageviews' : 1}})


    - The '$set' modifier sets the value of a field.  If the field does not yet exist, it will be 
        created.  

        > db.users.updateOne({'_id' : ObjectId('4b253b067525f35f94b60a31')},
                             {'$set' : {'favorite book' : 'War and Peace'}})


    - To remove a key from the document, the '$unset' modifier can be used.

        > db.users.updateOne({'name' : 'joe'},
                             {'$unset' : {'favorite book' : 1}})


    - The '$set' modifier can also be used to add and alter subdocuments.

        > db.blog.posts.updateOne({'author.name' : 'joe'},
                                  {'$set' : {'author.name' : 'joe schmoe'}})



- Incrementing and Decrementing

    - The '$inc' operator will add a new integer key if one does not yet exist.

        // Initialize the 'score' key with an initial value
        > db.games.updateOne({'game' : 'pinball', 'user' : 'joe'}, 
                             {'$inc' : {'score' : 50}})

        // Increment the score by 100
        > db.games.updateOne({'game' : 'pinball', 'user' : 'joe'},
                             {'$inc' : {'score' : 100}})

        // Pass in a negative number to decrement
        > db.games.updateOne({'game' : 'pinball', 'user' : 'joe'},
                             {'$inc' : {'score' : -1}})
